(function(I,F){"function"===typeof define&&define.amd?define([],F):"object"===typeof module&&module.exports?module.exports=F():I.fuzzysort=F()})(this,function(){function I(p){var f={single:function(a,d,b){if(!a)return null;C(a)||(a=f.getPreparedSearch(a));if(!d)return null;C(d)||(d=f.getPrepared(d));return((b&&void 0!==b.allowTypo?b.allowTypo:p&&void 0!==p.allowTypo?p.allowTypo:1)?f.algorithm:f.algorithmNoTypo)(a,d,a[0])},go:function(a,d,b){if(!a)return G;a=f.prepareSearch(a);var g=a[0],l=b&&b.threshold||
p&&p.threshold||-9007199254740991,m=b&&b.limit||p&&p.limit||9007199254740991,e=(b&&void 0!==b.allowTypo?b.allowTypo:p&&void 0!==p.allowTypo?p.allowTypo:1)?f.algorithm:f.algorithmNoTypo,c=0,n=0,k=d.length;if(b&&b.keys){var h=b.scoreFn||O;b=b.keys;var w=b.length;for(--k;0<=k;--k){for(var r=d[k],v=Array(w),u=w-1;0<=u;--u){var y=b[u],q=J(r,y);q?(C(q)||(q=f.getPrepared(q)),v[u]=e(a,q,g)):v[u]=null}v.obj=r;y=h(v);null===y||y<l||(v.score=y,c<m?(z.add(v),++c):(++n,y>z.peek().score&&z.replaceTop(v)))}}else if(b&&
b.key)for(y=b.key,--k;0<=k;--k){if(r=d[k],q=J(r,y))C(q)||(q=f.getPrepared(q)),h=e(a,q,g),null===h||h.score<l||(h={target:h.target,_targetLowerCodes:null,_nextBeginningIndexes:null,score:h.score,indexes:h.indexes,obj:r},c<m?(z.add(h),++c):(++n,h.score>z.peek().score&&z.replaceTop(h)))}else for(--k;0<=k;--k)if(q=d[k])C(q)||(q=f.getPrepared(q)),h=e(a,q,g),null===h||h.score<l||(c<m?(z.add(h),++c):(++n,h.score>z.peek().score&&z.replaceTop(h)));if(0===c)return G;a=Array(c);for(k=c-1;0<=k;--k)a[k]=z.poll();
a.total=c+n;return a},goAsync:function(a,d,b){var g=!1,l=new Promise(function(m,e){function c(){if(g)return e("canceled");var q=Date.now();if(b&&b.keys)for(var t=b.scoreFn||O,P=b.keys,Q=P.length;0<=h;--h){for(var A=d[h],D=Array(Q),H=Q-1;0<=H;--H){var L=P[H],x=J(A,L);x?(C(x)||(x=f.getPrepared(x)),D[H]=v(a,x,n)):D[H]=null}D.obj=A;A=t(D);if(null!==A&&!(A<w)&&(D.score=A,u<r?(k.add(D),++u):(++y,A>k.peek().score&&k.replaceTop(D)),0===h%1E3&&10<=Date.now()-q)){K?setImmediate(c):setTimeout(c);return}}else if(b&&
b.key)for(L=b.key;0<=h;--h){if(A=d[h],x=J(A,L))if(C(x)||(x=f.getPrepared(x)),t=v(a,x,n),null!==t&&!(t.score<w)&&(t={target:t.target,_targetLowerCodes:null,_nextBeginningIndexes:null,score:t.score,indexes:t.indexes,obj:A},u<r?(k.add(t),++u):(++y,t.score>k.peek().score&&k.replaceTop(t)),0===h%1E3&&10<=Date.now()-q)){K?setImmediate(c):setTimeout(c);return}}else for(;0<=h;--h)if(x=d[h])if(C(x)||(x=f.getPrepared(x)),t=v(a,x,n),null!==t&&!(t.score<w)&&(u<r?(k.add(t),++u):(++y,t.score>k.peek().score&&k.replaceTop(t)),
0===h%1E3&&10<=Date.now()-q)){K?setImmediate(c):setTimeout(c);return}if(0===u)return m(G);q=Array(u);for(t=u-1;0<=t;--t)q[t]=k.poll();q.total=u+y;m(q)}if(!a)return m(G);a=f.prepareSearch(a);var n=a[0],k=R(),h=d.length-1,w=b&&b.threshold||p&&p.threshold||-9007199254740991,r=b&&b.limit||p&&p.limit||9007199254740991,v=(b&&void 0!==b.allowTypo?b.allowTypo:p&&void 0!==p.allowTypo?p.allowTypo:1)?f.algorithm:f.algorithmNoTypo,u=0,y=0;K?setImmediate(c):c()});l.cancel=function(){g=!0};return l},highlight:function(a,
d,b){if(null===a)return null;void 0===d&&(d="<b>");void 0===b&&(b="</b>");var g="",l=0,m=!1,e=a.target,c=e.length;a=a.indexes;for(var n=0;n<c;++n){var k=e[n];if(a[l]===n){if(++l,m||(m=!0,g+=d),l===a.length){g+=k+b+e.substr(n+1);break}}else m&&(m=!1,g+=b);g+=k}return g},prepare:function(a){if(a)return{target:a,_targetLowerCodes:f.prepareLowerCodes(a),_nextBeginningIndexes:null,score:null,indexes:null,obj:null}},prepareSlow:function(a){if(a)return{target:a,_targetLowerCodes:f.prepareLowerCodes(a),_nextBeginningIndexes:f.prepareNextBeginningIndexes(a),
score:null,indexes:null,obj:null}},prepareSearch:function(a){if(a)return f.prepareLowerCodes(a)},getPrepared:function(a){if(999<a.length)return f.prepare(a);var d=M.get(a);if(void 0!==d)return d;d=f.prepare(a);M.set(a,d);return d},getPreparedSearch:function(a){if(999<a.length)return f.prepareSearch(a);var d=N.get(a);if(void 0!==d)return d;d=f.prepareSearch(a);N.set(a,d);return d},algorithm:function(a,d,b){for(var g=d._targetLowerCodes,l=a.length,m=g.length,e=0,c=0,n=0,k=0;;){var h=b===g[c];if(h){B[k++]=
c;++e;if(e===l)break;b=a[0===n?e:n===e?e+1:n===e-1?e-1:e]}++c;if(c>=m)for(;;){if(1>=e)return null;if(0===n){--e;c=a[e];if(b===c)continue;n=e}else{if(1===n)return null;--n;e=n;b=a[e+1];c=a[e];if(b===c)continue}k=e;c=B[k-1]+1;break}}b=e=0;var w=!1,r=0,v=d._nextBeginningIndexes;null===v&&(v=d._nextBeginningIndexes=f.prepareNextBeginningIndexes(d.target));var u=c=0===B[0]?0:v[B[0]-1];if(c!==m)for(;;)if(c>=m)if(0>=e){++b;if(b>l-2)break;a[b]!==a[b+1]&&(c=u)}else--e,c=E[--r],c=v[c];else if(h=a[0===b?e:b===
e?e+1:b===e-1?e-1:e]===g[c]){E[r++]=c;++e;if(e===l){w=!0;break}++c}else c=v[c];w?(a=E,g=r):(a=B,g=k);e=0;k=-1;for(r=0;r<l;++r)c=a[r],k!==c-1&&(e-=c),k=c;w?0!==b&&(e+=-20):(e*=1E3,0!==n&&(e+=-20));d.score=e-(m-l);d.indexes=Array(g);for(r=g-1;0<=r;--r)d.indexes[r]=a[r];return d},algorithmNoTypo:function(a,d,b){for(var g=d._targetLowerCodes,l=a.length,m=g.length,e=0,c=0,n=0;;){var k=b===g[c];if(k){B[n++]=c;++e;if(e===l)break;b=a[e]}++c;if(c>=m)return null}e=0;b=!1;var h=0,w=d._nextBeginningIndexes;null===
w&&(w=d._nextBeginningIndexes=f.prepareNextBeginningIndexes(d.target));c=0===B[0]?0:w[B[0]-1];if(c!==m)for(;;)if(c>=m){if(0>=e)break;--e;c=E[--h];c=w[c]}else if(k=a[e]===g[c]){E[h++]=c;++e;if(e===l){b=!0;break}++c}else c=w[c];b?(a=E,n=h):a=B;g=0;e=-1;for(h=0;h<l;++h)c=a[h],e!==c-1&&(g-=c),e=c;b||(g*=1E3);d.score=g-(m-l);d.indexes=Array(n);for(h=n-1;0<=h;--h)d.indexes[h]=a[h];return d},prepareLowerCodes:function(a){var d=a.length,b=[];a=a.toLowerCase();for(var g=0;g<d;++g)b[g]=a.charCodeAt(g);return b},
prepareBeginningIndexes:function(a){for(var d=a.length,b=[],g=0,l=!1,m=!1,e=0;e<d;++e){var c=a.charCodeAt(e),n=65<=c&&90>=c;c=n||97<=c&&122>=c||48<=c&&57>=c;var k=n&&!l||!m||!c;l=n;m=c;k&&(b[g++]=e)}return b},prepareNextBeginningIndexes:function(a){var d=a.length;a=f.prepareBeginningIndexes(a);for(var b=[],g=a[0],l=0,m=0;m<d;++m)g>m?b[m]=g:(g=a[++l],b[m]=void 0===g?d:g);return b},cleanup:F,"new":I};return f}function F(){M.clear();N.clear();B=[];E=[]}function O(p){for(var f=-9007199254740991,a=p.length-
1;0<=a;--a){var d=p[a];null!==d&&(d=d.score,d>f&&(f=d))}return-9007199254740991===f?null:f}function J(p,f){var a=p[f];if(void 0!==a)return a;a=f;Array.isArray(f)||(a=f.split("."));for(var d=a.length,b=-1;p&&++b<d;)p=p[a[b]];return p}function C(p){return"object"===typeof p}var K="undefined"!==typeof require&&"undefined"===typeof window,M=new Map,N=new Map,G=[];G.total=0;var B=[],E=[],R=function(){function p(){for(var b=0,g=f[b],l=1;l<a;){var m=l+1;b=l;m<a&&f[m].score<f[l].score&&(b=m);f[b-1>>1]=f[b];
l=1+(b<<1)}for(l=b-1>>1;0<b&&g.score<f[l].score;l=(b=l)-1>>1)f[b]=f[l];f[b]=g}var f=[],a=0,d={};return d.add=function(b){var g=a;f[a++]=b;for(var l=g-1>>1;0<g&&b.score<f[l].score;l=(g=l)-1>>1)f[g]=f[l];f[g]=b},d.poll=function(){if(0!==a){var b=f[0];return f[0]=f[--a],p(),b}},d.peek=function(b){if(0!==a)return f[0]},d.replaceTop=function(b){f[0]=b;p()},d},z=R();return I()});